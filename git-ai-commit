#!/bin/bash

# git-ai-commit - Generate commit messages using AI based on git diff
# Usage: git-ai-commit [options]

set -e

# Default values
STAGED_ONLY=false
INCLUDE_CONTEXT=false
DRY_RUN=false
AI_PROVIDER="gemini"
MAX_DIFF_LINES=500

# API Configuration - can be overridden by environment variables
CLAUDE_API_URL="${CLAUDE_API_URL:-https://api.anthropic.com/v1/messages}"
OPENAI_API_URL="${OPENAI_API_URL:-https://api.openai.com/v1/chat/completions}"
GEMINI_API_URL="${GEMINI_API_URL:-https://generativelanguage.googleapis.com/v1beta/models}"
CLAUDE_MODEL="claude-3-sonnet-20240229"
OPENAI_MODEL="gpt-4"
GEMINI_MODEL="gemini-1.5-flash"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print usage information
show_help() {
    cat << EOF
git-ai-commit - Generate commit messages using AI based on git diff

USAGE:
    git-ai-commit [OPTIONS]

OPTIONS:
    -s, --staged        Only analyze staged changes (default: all changes)
    -c, --context       Include more context in the analysis
    -d, --dry-run       Show the commit message without committing
    -p, --provider      AI provider to use (claude, openai, gemini) [default: claude]
    -l, --limit         Maximum number of diff lines to analyze [default: 500]
    -h, --help          Show this help message

EXAMPLES:
    git-ai-commit                    # Analyze all changes and commit
    git-ai-commit --staged           # Only analyze staged changes
    git-ai-commit --dry-run          # Show commit message without committing
    git-ai-commit --context          # Include more context in analysis

REQUIREMENTS:
    - git repository
    - curl or wget for HTTP requests
    - API key configured (ANTHROPIC_API_KEY, OPENAI_API_KEY, or GEMINI_API_KEY)
    - Active git changes to analyze

ENVIRONMENT VARIABLES:
    ANTHROPIC_API_KEY    API key for Claude (required for claude provider)
    OPENAI_API_KEY       API key for OpenAI (required for openai provider)
    GEMINI_API_KEY       API key for Gemini (required for gemini provider)
    GIT_AI_COMMIT_MODEL  Override default model
    CLAUDE_API_URL       Override Claude API base URL
    OPENAI_API_URL       Override OpenAI API base URL
    GEMINI_API_URL       Override Gemini API base URL

EOF
}

# Print error message and exit
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Print info message
info() {
    echo -e "${BLUE}Info: $1${NC}"
}

# Print success message
success() {
    echo -e "${GREEN}Success: $1${NC}"
}

# Print warning message
warn() {
    echo -e "${YELLOW}Warning: $1${NC}"
}

# Check if we're in a git repository
check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        error "Not in a git repository"
    fi
}

# Check if required tools and API keys are available
check_dependencies() {
    # Check for curl or wget
    if ! command -v curl &> /dev/null && ! command -v wget &> /dev/null; then
        error "curl or wget is required for HTTP requests"
    fi
    
    # Check API key based on provider
    case $AI_PROVIDER in
        claude)
            if [[ -z "$ANTHROPIC_API_KEY" ]]; then
                error "ANTHROPIC_API_KEY environment variable is required for Claude provider"
            fi
            ;;
        openai)
            if [[ -z "$OPENAI_API_KEY" ]]; then
                error "OPENAI_API_KEY environment variable is required for OpenAI provider"
            fi
            ;;
        gemini)
            if [[ -z "$GEMINI_API_KEY" ]]; then
                error "GEMINI_API_KEY environment variable is required for Gemini provider"
            fi
            ;;
        *)
            error "Unsupported AI provider: $AI_PROVIDER"
            ;;
    esac
}

# Get git diff based on options
get_git_diff() {
    local diff_cmd="git diff"
    
    if [[ "$STAGED_ONLY" == "true" ]]; then
        diff_cmd="git diff --staged"
    fi
    
    # Add context if requested
    if [[ "$INCLUDE_CONTEXT" == "true" ]]; then
        diff_cmd="$diff_cmd --unified=5"
    else
        diff_cmd="$diff_cmd --unified=3"
    fi
    
    # Get the diff and limit lines if specified
    local diff_output
    diff_output=$(eval "$diff_cmd" 2>/dev/null)
    
    if [[ -z "$diff_output" ]]; then
        if [[ "$STAGED_ONLY" == "true" ]]; then
            error "No staged changes found"
        else
            error "No changes found"
        fi
    fi
    
    # Limit diff lines if specified
    if [[ $MAX_DIFF_LINES -gt 0 ]]; then
        diff_output=$(echo "$diff_output" | head -n "$MAX_DIFF_LINES")
        local total_lines
        total_lines=$(eval "$diff_cmd" 2>/dev/null | wc -l)
        if [[ $total_lines -gt $MAX_DIFF_LINES ]]; then
            warn "Diff truncated to $MAX_DIFF_LINES lines (was $total_lines lines)"
        fi
    fi
    
    echo "$diff_output"
}

# Make HTTP request using curl or wget
make_http_request() {
    local url="$1"
    local headers="$2"
    local data="$3"
    
    if command -v curl &> /dev/null; then
        curl -s -X POST "$url" \
             -H "Content-Type: application/json" \
             $headers \
             -d "$data"
    elif command -v wget &> /dev/null; then
        echo "$data" | wget -q -O- \
                           --header="Content-Type: application/json" \
                           $headers \
                           --post-data=@- \
                           "$url"
    else
        error "Neither curl nor wget available"
    fi
}

# Generate commit message using Claude API
generate_commit_message_claude() {
    local diff_content="$1"
    local model="${GIT_AI_COMMIT_MODEL:-$CLAUDE_MODEL}"
    
    local prompt="Based on the following git diff, generate a concise and descriptive commit message following conventional commit format (type: description). Focus on what changed and why, not implementation details.

Git diff:
$diff_content

Requirements:
- Use conventional commit format: type(scope): description
- Keep the message under 72 characters for the first line
- Be specific about what changed
- Focus on the 'why' rather than the 'how'
- Use present tense, imperative mood
- Common types: feat, fix, docs, style, refactor, test, chore

Generate only the commit message, no additional text:"

    local json_data=$(cat <<EOF
{
    "model": "$model",
    "max_tokens": 100,
    "messages": [
        {
            "role": "user",
            "content": $(echo "$prompt" | jq -Rs .)
        }
    ]
}
EOF
)

    local response
    response=$(make_http_request "$CLAUDE_API_URL" \
               "-H \"x-api-key: $ANTHROPIC_API_KEY\" -H \"anthropic-version: 2023-06-01\"" \
               "$json_data")
    
    if [[ $? -ne 0 ]]; then
        error "Failed to call Claude API"
    fi
    
    # Extract message content from response
    echo "$response" | jq -r '.content[0].text' 2>/dev/null || {
        error "Failed to parse Claude API response"
    }
}

# Generate commit message using OpenAI API
generate_commit_message_openai() {
    local diff_content="$1"
    local model="${GIT_AI_COMMIT_MODEL:-$OPENAI_MODEL}"
    
    local prompt="Based on the following git diff, generate a concise and descriptive commit message following conventional commit format (type: description). Focus on what changed and why, not implementation details.

Git diff:
$diff_content

Requirements:
- Use conventional commit format: type(scope): description
- Keep the message under 72 characters for the first line
- Be specific about what changed
- Focus on the 'why' rather than the 'how'
- Use present tense, imperative mood
- Common types: feat, fix, docs, style, refactor, test, chore

Generate only the commit message, no additional text:"

    local json_data=$(cat <<EOF
{
    "model": "$model",
    "max_tokens": 100,
    "messages": [
        {
            "role": "user",
            "content": $(echo "$prompt" | jq -Rs .)
        }
    ]
}
EOF
)

    local response
    response=$(make_http_request "$OPENAI_API_URL" \
               "-H \"Authorization: Bearer $OPENAI_API_KEY\"" \
               "$json_data")
    
    if [[ $? -ne 0 ]]; then
        error "Failed to call OpenAI API"
    fi
    
    # Extract message content from response
    echo "$response" | jq -r '.choices[0].message.content' 2>/dev/null || {
        error "Failed to parse OpenAI API response"
    }
}

# Generate commit message using Gemini API
generate_commit_message_gemini() {
    local diff_content="$1"
    local model="${GIT_AI_COMMIT_MODEL:-$GEMINI_MODEL}"
    
    local prompt="Based on the following git diff, generate a concise and descriptive commit message following conventional commit format (type: description). Focus on what changed and why, not implementation details.

Git diff:
$diff_content

Requirements:
- Use conventional commit format: type(scope): description
- Keep the message under 72 characters for the first line
- Be specific about what changed
- Focus on the 'why' rather than the 'how'
- Use present tense, imperative mood
- Common types: feat, fix, docs, style, refactor, test, chore

Generate only the commit message, no additional text:"

    local json_data=$(cat <<EOF
{
    "contents": [
        {
            "parts": [
                {
                    "text": $(echo "$prompt" | jq -Rs .)
                }
            ]
        }
    ],
    "generationConfig": {
        "maxOutputTokens": 100,
        "temperature": 0.3
    }
}
EOF
)

    local api_url="${GEMINI_API_URL}/${model}:generateContent?key=${GEMINI_API_KEY}"
    local response
    response=$(make_http_request "$api_url" "" "$json_data")
    
    if [[ $? -ne 0 ]]; then
        error "Failed to call Gemini API"
    fi
    
    # Extract message content from response
    echo "$response" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || {
        error "Failed to parse Gemini API response"
    }
}

# Generate commit message using AI
generate_commit_message() {
    local diff_content="$1"
    
    case $AI_PROVIDER in
        claude)
            generate_commit_message_claude "$diff_content"
            ;;
        openai)
            generate_commit_message_openai "$diff_content"
            ;;
        gemini)
            generate_commit_message_gemini "$diff_content"
            ;;
        *)
            error "Unsupported AI provider: $AI_PROVIDER"
            ;;
    esac
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -s|--staged)
                STAGED_ONLY=true
                shift
                ;;
            -c|--context)
                INCLUDE_CONTEXT=true
                shift
                ;;
            -d|--dry-run)
                DRY_RUN=true
                shift
                ;;
            -p|--provider)
                AI_PROVIDER="$2"
                shift 2
                ;;
            -l|--limit)
                MAX_DIFF_LINES="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                error "Unknown option: $1. Use --help for usage information."
                ;;
        esac
    done
}

# Main execution
main() {
    parse_args "$@"
    
    info "Checking git repository..."
    check_git_repo
    
    info "Checking dependencies..."
    check_dependencies
    
    info "Analyzing changes..."
    local diff_content
    diff_content=$(get_git_diff)
    
    info "Generating commit message using $AI_PROVIDER..."
    local commit_message
    commit_message=$(generate_commit_message "$diff_content")
    
    if [[ -z "$commit_message" ]]; then
        error "Failed to generate commit message"
    fi
    
    # Clean up the commit message (remove any extra whitespace/newlines)
    commit_message=$(echo "$commit_message" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | head -n 1)
    
    echo
    echo -e "${GREEN}Generated commit message:${NC}"
    echo -e "${YELLOW}$commit_message${NC}"
    echo
    
    if [[ "$DRY_RUN" == "true" ]]; then
        info "Dry run mode - not committing"
        exit 0
    fi
    
    # Ask for confirmation
    read -p "Do you want to commit with this message? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        if [[ "$STAGED_ONLY" == "false" ]]; then
            info "Adding all changes to staging area..."
            git add -A
        fi
        
        info "Creating commit..."
        git commit -m "$commit_message"
        success "Commit created successfully!"
    else
        info "Commit cancelled"
    fi
}

# Run main function with all arguments
main "$@"
